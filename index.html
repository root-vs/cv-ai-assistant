<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>NeonPipe AI – Futuristic Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #030712;
      --bg-alt: #050816;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --accent-strong: #0ea5e9;
      --danger: #f97373;
      --user-msg: #0f172a;
      --ai-msg: #020617;
      --text-main: #e5e7eb;
      --text-muted: #6b7280;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --radius-lg: 18px;
      --radius-xl: 24px;
      --blur-bg: blur(22px);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617 55%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
      overflow: hidden;
    }

    .background-orbit {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      background:
        radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.25) 0, transparent 55%),
        radial-gradient(circle at 90% 80%, rgba(56, 189, 248, 0.18) 0, transparent 52%),
        radial-gradient(circle at 50% 50%, rgba(14, 116, 144, 0.18) 0, transparent 55%);
      opacity: 0.9;
      filter: saturate(1.4);
    }

    .orbital-lines {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      background-image: radial-gradient(circle at center, rgba(15, 23, 42, 0.8) 0, rgba(15, 23, 42, 0.98) 50%, #020617 100%),
        repeating-radial-gradient(circle at center, rgba(15, 23, 42, 0) 0, rgba(15, 23, 42, 0) 14px, rgba(15, 23, 42, 0.7) 15px),
        linear-gradient(
          120deg,
          rgba(56, 189, 248, 0.14),
          rgba(129, 140, 248, 0.08),
          rgba(56, 189, 248, 0.18)
        );
      mix-blend-mode: screen;
      opacity: 0.2;
    }

    .shell {
      position: relative;
      width: min(900px, 100%);
      height: min(720px, 100vh - 32px);
      margin: auto;
      border-radius: 32px;
      padding: 1px;
      background:
        linear-gradient(135deg, rgba(15, 118, 110, 0.6), rgba(37, 99, 235, 0.85)),
        linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(56, 189, 248, 0.1));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.95),
        0 40px 120px rgba(15, 23, 42, 0.9),
        0 0 120px rgba(37, 99, 235, 0.4);
      overflow: hidden;
    }

    .shell-inner {
      position: relative;
      height: 100%;
      border-radius: 30px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), #020617 55%);
      display: flex;
      flex-direction: column;
      padding: 16px 18px 18px;
      overflow: hidden;
    }

    .glass-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.86));
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.1),
        0 18px 40px rgba(15, 23, 42, 0.85);
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }

    .glass-top::before {
      content: "";
      position: absolute;
      inset: -40px;
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.35), transparent 65%),
        radial-gradient(circle at 100% 0, rgba(56, 189, 248, 0.22), transparent 55%);
      opacity: 0.9;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .avatar-orb {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background:
        conic-gradient(
          from 220deg,
          #38bdf8,
          #a855f7,
          #f97316,
          #22c55e,
          #38bdf8
        );
      padding: 2px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 0 40px rgba(56, 189, 248, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-core {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 30%, #e0f2fe, #0f172a 65%);
      position: relative;
      overflow: hidden;
    }

    .avatar-core::after {
      content: "";
      position: absolute;
      width: 70%;
      height: 70%;
      border-radius: inherit;
      inset: 15%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: inset 0 0 25px rgba(15, 23, 42, 0.9);
      opacity: 0.78;
    }

    .top-text-main {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .top-text-main span.pipe-tag {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.45);
      background: radial-gradient(circle at top left, rgba(8, 47, 73, 0.85), rgba(15, 23, 42, 0.95));
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.17em;
      color: #bae6fd;
    }

    .top-sub {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.82;
      margin-top: 2px;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 9px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.3), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(34, 197, 94, 0.65);
      box-shadow:
        0 0 0 1px rgba(22, 101, 52, 0.5),
        0 0 30px rgba(34, 197, 94, 0.3);
      font-size: 11px;
      color: #bbf7d0;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.8), 0 0 16px rgba(34, 197, 94, 0.8);
      position: relative;
    }

    .status-dot::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: inherit;
      border: 1px solid rgba(22, 163, 74, 0.9);
      opacity: 0.7;
    }

    .model-pill {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.24), rgba(15, 23, 42, 0.95));
      font-size: 11px;
      color: #c7d2fe;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .model-pill code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.75);
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    .model-pill span.dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
    }

    .panel-main {
      flex: 1;
      margin-top: 8px;
      display: grid;
      grid-template-rows: minmax(0, 1fr) auto;
      gap: 10px;
      min-height: 0;
    }

    .chat-frame {
      position: relative;
      border-radius: 20px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), #020617 65%);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.95),
        0 18px 60px rgba(15, 23, 42, 0.9);
      padding: 12px 12px 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .chat-frame::before {
      content: "";
      position: absolute;
      inset: -80%;
      background:
        radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.09), transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(56, 189, 248, 0.09), transparent 60%);
      mix-blend-mode: screen;
      opacity: 1;
      pointer-events: none;
    }

    .timeline {
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.85);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 0 2px;
      z-index: 1;
      position: relative;
    }

    .timeline-line {
      flex: 1;
      height: 1px;
      background: linear-gradient(
        90deg,
        rgba(15, 23, 42, 0),
        rgba(148, 163, 184, 0.45),
        rgba(15, 23, 42, 0)
      );
    }

    .timeline-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
    }

    .chat-scroll {
      position: relative;
      flex: 1;
      overflow: auto;
      padding: 4px 2px 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scroll-behavior: smooth;
      z-index: 1;
    }

    .chat-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .chat-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    .chat-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, rgba(56, 189, 248, 0.4), rgba(59, 130, 246, 0.3));
      border-radius: 999px;
    }

    .msg-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-badge {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .msg-badge.ai {
      background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.26), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #e0f2fe;
    }

    .msg-badge.user {
      background: radial-gradient(circle at 30% 0, rgba(251, 146, 60, 0.3), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(251, 146, 60, 0.7);
      color: #fed7aa;
    }

    .msg-bubble {
      max-width: 72%;
      padding: 10px 12px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
      border: 1px solid rgba(30, 64, 175, 0.6);
      background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: var(--text-main);
    }

    .msg-row.user .msg-bubble {
      background: radial-gradient(circle at 100% 0, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-color: rgba(56, 189, 248, 0.5);
      box-shadow: 0 0 24px rgba(56, 189, 248, 0.28);
    }

    .msg-row.ai .msg-bubble {
      background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-color: rgba(129, 140, 248, 0.6);
      box-shadow: 0 0 24px rgba(129, 140, 248, 0.26);
    }

    .msg-meta {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .msg-meta span.dot {
      width: 3px;
      height: 3px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.7);
    }

    .msg-streaming {
      position: relative;
    }

    .msg-streaming::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(
        120deg,
        transparent 0%,
        rgba(56, 189, 248, 0.12) 45%,
        transparent 100%
      );
      opacity: 0.6;
      mix-blend-mode: screen;
      pointer-events: none;
      animation: shimmer 1.4s linear infinite;
    }

    @keyframes shimmer {
      from {
        transform: translateX(-40%);
      }
      to {
        transform: translateX(40%);
      }
    }

    .typing-dots {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .typing-dots span {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
      animation: pulse 1s ease-in-out infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.15s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes pulse {
      0%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      50% {
        transform: translateY(-3px);
        opacity: 1;
      }
    }

    .panel-bottom {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 10px;
      align-items: stretch;
    }

    @media (max-width: 768px) {
      .panel-bottom {
        grid-template-columns: minmax(0, 1fr);
      }
      .msg-bubble {
        max-width: 100%;
      }
    }

    .composer {
      position: relative;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 9px 10px 9px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 24px 50px rgba(15, 23, 42, 0.9);
    }

    .composer-top {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .prompt-label {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.92);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .prompt-label span.dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .prompt-hint {
      margin-left: auto;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .kbd {
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      padding: 2px 5px;
      border-radius: 5px;
      border: 1px solid rgba(31, 41, 55, 1);
      background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
      color: rgba(148, 163, 184, 0.9);
    }

    .composer-main {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .composer-input-wrap {
      position: relative;
      flex: 1;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 8px 10px;
      display: flex;
    }

    textarea#user-input {
      width: 100%;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      color: var(--text-main);
      font: inherit;
      font-size: 13px;
      max-height: 120px;
    }

    textarea#user-input::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    .composer-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .btn-primary {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      color: #0b1120;
      background: radial-gradient(circle at 30% 0, #38bdf8, #0ea5e9);
      box-shadow:
        0 0 0 1px rgba(8, 47, 73, 0.9),
        0 12px 30px rgba(56, 189, 248, 0.6);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(8, 47, 73, 0.9),
        0 18px 40px rgba(56, 189, 248, 0.8);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow:
        0 0 0 1px rgba(8, 47, 73, 0.9),
        0 8px 22px rgba(56, 189, 248, 0.5);
    }

    .btn-primary[disabled] {
      cursor: wait;
      opacity: 0.7;
      transform: none;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 6px 14px rgba(15, 23, 42, 0.9);
    }

    .btn-stop {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      cursor: pointer;
      background: radial-gradient(circle at 30% 0, rgba(248, 113, 113, 0.4), rgba(15, 23, 42, 1));
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.8);
      display: none;
      align-items: center;
      gap: 5px;
    }

    .btn-stop.visible {
      display: inline-flex;
    }

    .btn-stop-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #fca5a5;
      box-shadow:
        0 0 0 1px rgba(185, 28, 28, 0.9),
        0 0 12px rgba(248, 113, 113, 0.9);
    }

    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge span.dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .meta-panel {
      border-radius: 18px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 9px 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 24px 50px rgba(15, 23, 42, 0.9);
    }

    .meta-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
    }

    .meta-header span.title {
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .meta-content {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .meta-row strong {
      font-weight: 500;
      color: rgba(209, 213, 219, 0.96);
    }

    .meta-pill {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(51, 65, 85, 0.95);
      color: rgba(148, 163, 184, 0.98);
    }

    .meta-warning {
      margin-top: 4px;
      font-size: 10px;
      color: rgba(248, 250, 252, 0.9);
      padding: 6px 7px;
      border-radius: 10px;
      border: 1px dashed rgba(239, 68, 68, 0.8);
      background: radial-gradient(circle at 0 0, rgba(127, 29, 29, 0.95), rgba(15, 23, 42, 1));
      display: flex;
      gap: 6px;
    }

    .meta-warning span.icon {
      font-size: 12px;
    }

    .error-banner {
      margin-top: 6px;
      font-size: 11px;
      color: #fecaca;
      padding: 6px 9px;
      border-radius: 10px;
      border: 1px solid rgba(248, 113, 113, 0.8);
      background: radial-gradient(circle at 0 0, rgba(127, 29, 29, 0.96), rgba(15, 23, 42, 1));
      display: none;
      align-items: center;
      gap: 6px;
    }

    .error-banner.visible {
      display: flex;
    }

    .error-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
      box-shadow:
        0 0 0 1px rgba(127, 29, 29, 1),
        0 0 20px rgba(248, 113, 113, 1);
    }

    .error-text {
      flex: 1;
    }

    .error-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(15, 23, 42, 0.98);
      color: #fecaca;
    }
  </style>
</head>
<body>
  <div class="background-orbit"></div>
  <div class="orbital-lines"></div>

  <div class="shell">
    <div class="shell-inner">
      <header class="glass-top">
        <div class="top-left">
          <div class="avatar-orb">
            <div class="avatar-core"></div>
          </div>
          <div>
            <div class="top-text-main">
              NeonPipe AI
              <span class="pipe-tag">Langbase Pipe</span>
            </div>
            <div class="top-sub">
              Interfaccia chat futuristica collegata a <span style="color:#38bdf8;font-weight:500;margin-left:2px;">/v1/pipes/run</span>
            </div>
          </div>
        </div>
        <div class="top-right">
          <div class="status-pill">
            <div class="status-dot"></div>
            LIVE PIPE LINKED
          </div>
          <div class="model-pill">
            <span class="dot"></span>
            <span>Thread aware</span>
            <code>pipe.run(stream=true)</code>
          </div>
        </div>
      </header>

      <main class="panel-main">
        <section class="chat-frame">
          <div class="timeline">
            <span class="timeline-dot"></span>
            OUTPUT STREAM
            <div class="timeline-line"></div>
          </div>
          <div id="chat-scroll" class="chat-scroll">
            <div class="msg-row ai">
              <div class="msg-badge ai">AI</div>
              <div class="msg-bubble">
                <div>
                  Ciao Valerio, sono il tuo pipe futuristico. Chiedimi qualcosa come:
                  <br />
                  <span style="color:#bae6fd;">“Dove ha studiato Valerio?”</span>
                </div>
                <div class="msg-meta">
                  <span>Pipe inizializzato</span>
                  <span class="dot"></span>
                  <span>Streaming attivo</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="panel-bottom">
          <div class="composer">
            <div class="composer-top">
              <div class="prompt-label">
                <span class="dot"></span>
                Prompt
              </div>
              <div class="prompt-hint">
                <span class="kbd">Shift</span> + <span class="kbd">Invio</span> per nuova riga
              </div>
            </div>

            <div class="composer-main">
              <div class="composer-input-wrap">
                <textarea
                  id="user-input"
                  rows="1"
                  placeholder="Scrivi qui la tua domanda per il pipe Langbase..."
                ></textarea>
              </div>
              <div class="composer-actions">
                <button id="send-btn" class="btn-primary">
                  <span>Invia</span>
                  <span style="font-size:13px;">➤</span>
                </button>
                <button id="stop-btn" class="btn-stop">
                  <span class="btn-stop-dot"></span>
                  <span>Stop stream</span>
                </button>
              </div>
            </div>

            <div id="error-banner" class="error-banner">
              <div class="error-dot"></div>
              <div class="error-text" id="error-text">
                Errore durante la chiamata a Langbase.
              </div>
              <div class="error-code" id="error-code">
                —
              </div>
            </div>
          </div>

          <aside class="meta-panel">
            <div class="meta-header">
              <span class="title">Pipe link</span>
              <span class="badge">
                <span class="dot"></span>
                v1 · pipes · run
              </span>
            </div>
            <div class="meta-content">
              <div class="meta-row">
                <strong>Endpoint</strong>
                <span class="meta-pill">POST /v1/pipes/run</span>
              </div>
              <div class="meta-row">
                <strong>Header</strong>
                <span class="meta-pill">Authorization: Bearer pipe_…</span>
              </div>
              <div class="meta-row">
                <strong>Stream</strong>
                <span class="meta-pill">"stream": true</span>
              </div>
              <div class="meta-row">
                <strong>Body</strong>
                <span class="meta-pill">{"messages":[{"role":"user","content":"..."}</span>
              </div>
              <div class="meta-warning">
                <span class="icon">!</span>
                <span>
                  Non esporre chiavi sensibili in produzione: usa variabili d’ambiente, un backend o un proxy sicuro.
                </span>
              </div>
            </div>
          </aside>
        </section>
      </main>
    </div>
  </div>

  <script>
    const API_URL = "https://api.langbase.com/v1/pipes/run";

    // Sostituisci con la tua chiave pipe_...
    const PIPE_API_KEY = "PIPE_API_KEY_HERE";

    const chatScroll = document.getElementById("chat-scroll");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const stopBtn = document.getElementById("stop-btn");
    const errorBanner = document.getElementById("error-banner");
    const errorText = document.getElementById("error-text");
    const errorCode = document.getElementById("error-code");

    let currentAbortController = null;
    let threadId = null; // se vuoi gestire conversazioni persistenti con Langbase

    const messages = [
      {
        role: "system",
        content: "Sei un assistente chiamato NeonPipe AI. Rispondi in italiano in modo chiaro e sintetico."
      }
    ];

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chatScroll.scrollTop = chatScroll.scrollHeight;
      });
    }

    function createMessageRow(role, text, { streaming = false } = {}) {
      const row = document.createElement("div");
      row.className = `msg-row ${role === "user" ? "user" : "ai"}`;

      const badge = document.createElement("div");
      badge.className = `msg-badge ${role === "user" ? "user" : "ai"}`;
      badge.textContent = role === "user" ? "ME" : "AI";

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      if (streaming) {
        bubble.classList.add("msg-streaming");
      }

      const content = document.createElement("div");
      content.className = "msg-text";
      content.textContent = text;

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      const metaLabel = document.createElement("span");
      metaLabel.textContent = role === "user" ? "Input utente" : "Risposta pipe";
      const dot = document.createElement("span");
      dot.className = "dot";
      const metaExtra = document.createElement("span");
      metaExtra.textContent = new Date().toLocaleTimeString("it-IT", {
        hour: "2-digit",
        minute: "2-digit"
      });

      meta.appendChild(metaLabel);
      meta.appendChild(dot);
      meta.appendChild(metaExtra);

      bubble.appendChild(content);
      bubble.appendChild(meta);

      row.appendChild(badge);
      row.appendChild(bubble);

      chatScroll.appendChild(row);
      scrollToBottom();

      return { row, bubble, content };
    }

    function showTypingIndicator() {
      const { bubble, content } = createMessageRow("assistant", "", {
        streaming: true
      });

      const typingWrapper = document.createElement("div");
      typingWrapper.className = "typing-dots";
      typingWrapper.innerHTML = "<span></span><span></span><span></span>";

      content.appendChild(typingWrapper);
      return { bubble, content };
    }

    function setStreamingState(isStreaming) {
      if (isStreaming) {
        sendBtn.disabled = true;
        stopBtn.classList.add("visible");
      } else {
        sendBtn.disabled = false;
        stopBtn.classList.remove("visible");
      }
    }

    function showError(message, code) {
      errorBanner.classList.add("visible");
      errorText.textContent = message || "Errore non specificato.";
      errorCode.textContent = code ? String(code) : "N/D";
    }

    function clearError() {
      errorBanner.classList.remove("visible");
    }

    async function sendMessage() {
      clearError();

      const content = userInput.value.trim();
      if (!content) return;

      if (!PIPE_API_KEY || PIPE_API_KEY === "PIPE_API_KEY_HERE") {
        showError("Devi configurare una API key Langbase pipe_… prima di usare il chatbot.", "NO_KEY");
        return;
      }

      messages.push({ role: "user", content });

      createMessageRow("user", content);
      userInput.value = "";
      userInput.style.height = "auto";

      const { bubble, content: aiContent } = showTypingIndicator();
      setStreamingState(true);

      currentAbortController = new AbortController();
      const signal = currentAbortController.signal;

      try {
        const body = {
          messages: messages,
          stream: true
        };

        if (threadId) {
          body.threadId = threadId;
        }

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${PIPE_API_KEY}`
          },
          body: JSON.stringify(body),
          signal
        });

        if (!response.ok || !response.body) {
          const errorText = await response.text().catch(() => "");
          throw new Error(
            `HTTP ${response.status}: ${errorText || response.statusText || "Errore sconosciuto"}`
          );
        }

        aiContent.textContent = "";
        bubble.classList.add("msg-streaming");

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullText = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });

          // Adatta questo parsing al formato di streaming reale di Langbase.
          // Qui assumo testo diretto o JSONL-style.
          const lines = chunk.split(/\r?\n/).filter(Boolean);
          for (const line of lines) {
            let delta = line;

            if (line.startsWith("data:")) {
              delta = line.slice(5).trim();
            }

            if (!delta) continue;

            try {
              const obj = JSON.parse(delta);
              // Adatta se la struttura è diversa (es: obj.choices[0].delta.content, obj.data, ecc.)
              const maybeText =
                obj?.choices?.[0]?.delta?.content ??
                obj?.delta ??
                obj?.data ??
                obj?.content ??
                "";

              if (typeof maybeText === "string") {
                fullText += maybeText;
                aiContent.textContent = fullText;
              }
            } catch {
              fullText += delta;
              aiContent.textContent = fullText;
            }

            scrollToBottom();
          }
        }

        bubble.classList.remove("msg-streaming");
        messages.push({ role: "assistant", content: fullText });

        setStreamingState(false);
        currentAbortController = null;
      } catch (err) {
        console.error(err);
        bubble.classList.remove("msg-streaming");
        aiContent.textContent =
          aiContent.textContent || "Si è verificato un errore durante lo streaming della risposta.";

        let code = "FETCH_ERROR";
        if (err && typeof err === "object") {
          if (err.name === "AbortError") {
            code = "ABORTED";
          }
        }
        showError(err.message || "Errore di rete.", code);
        setStreamingState(false);
        currentAbortController = null;
      }
    }

    sendBtn.addEventListener("click", () => {
      sendMessage();
    });

    stopBtn.addEventListener("click", () => {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
        setStreamingState(false);
      }
    });

    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    userInput.addEventListener("input", () => {
      userInput.style.height = "auto";
      userInput.style.height = Math.min(userInput.scrollHeight, 120) + "px";
    });
  </script>
</body>
</html>
