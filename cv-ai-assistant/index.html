<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>V.E.R.A.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://api.fontshare.com/v2/css?f[]=general-sans@400,500,600&display=swap" rel="stylesheet">

  <!-- Collega il tuo file CSS -->
  <link rel="stylesheet" href="cv_ai_assistant_styles.css">
</head>

<body class="dark">
  <div class="container">
    <header>
      <span>V.E.R.A. (Valerio‚Äôs Enhanced RAG Assistant)</span>

      <div class="header-right">
        <!-- Home button -->
        <button class="classic-icon-btn" title="Open classic CV site"
          onclick="window.location.href='../index.html'">
          üè†Ô∏é
        </button>
        <!-- Reload button -->
        <button class="classic-icon-btn" title="Reload page" onclick="location.reload()">
          ‚ü≥
        </button>
        <!-- Toggle -->
        <div class="theme-toggle" id="themeToggle">
          <div class="toggle-icon sun">‚òÄÔ∏è</div>
          <div class="toggle-icon moon">üåô</div>
          <div class="toggle-ball"></div>
        </div>
      </div>
    </header>

    <div id="chat" class="chat">
      <!-- Onboarding -->
      <div id="onboarding" class="onboarding">
        <div class="avatar-large" id="avatarLarge">
          <img src="../images/avatar.png" alt="Avatar">
        </div>
        <div class="greeting">Hi there üëã, I‚Äôm V.E.R.A.
          I can help you explore Valerio‚Äôs experience, skills, and career.
          Write your question below, or pick one of the suggestions.</div>
        <div class="tips">
          <div class="tip">Tell me about Valerio?</div>
          <div class="tip">What is Valerio‚Äôs work experience?</div>
          <div class="tip">Has Valerio published anything?</div>
          <div class="tip">What is Valerio‚Äôs education?</div>
          <div class="tip">How can I reach Valerio?</div>
        </div>
      </div>
    </div>

    <div class="composer">
      <textarea id="input" placeholder="Write a question..."></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const API_URL = "https://api.langbase.com/v1/pipes/run";
    const API_KEY = "";

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const onboarding = document.getElementById("onboarding");
    const themeToggle = document.getElementById("themeToggle");

    let controller = null;
    const messages = [];

    // ‚≠ê Tutte le suggestions disponibili (ordine completo)
    const allSuggestions = [
      "Tell me about Valerio?",
      "What is Valerio‚Äôs work experience?",
      "Has Valerio published anything?",
      "What is Valerio‚Äôs education?",
      "How can I reach Valerio?"
    ];

    // ‚≠ê Le prime 3 visibili
    let visibleSuggestions = allSuggestions.slice(0, 3);

    // ‚≠ê Le rimanenti da mostrare dopo
    let remainingSuggestions = allSuggestions.slice(3);

    function renderSuggestions() {
      const tipsContainer = document.createElement("div");
      tipsContainer.className = "tips";

      visibleSuggestions.forEach(s => {
        const tip = document.createElement("div");
        tip.className = "tip";
        tip.textContent = s;
        tip.onclick = () => handleQuestion(s);
        tipsContainer.appendChild(tip);
      });

      chat.appendChild(tipsContainer);
      chat.scrollTop = chat.scrollHeight;
    }

    function addMessage(role, text) {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function showTyping() {
      const wrapper = document.createElement("div");
      wrapper.className = "typing-indicator";
      wrapper.innerHTML = `
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    `;
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      return wrapper;
    }

    function addAiResponse(text) {
      const thoughtRow = document.createElement("div");
      thoughtRow.className = "thought";

      const avatarSmall = document.createElement("div");
      avatarSmall.className = "avatar-small";
      avatarSmall.innerHTML = `<img src="../images/avatar.png" alt="Avatar" style="width:100%;height:100%;object-fit:cover;">`;

      const bubble = document.createElement("div");
      bubble.className = "msg ai";
      bubble.textContent = text;

      thoughtRow.appendChild(avatarSmall);
      thoughtRow.appendChild(bubble);

      chat.appendChild(thoughtRow);
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    async function handleQuestion(text) {
      if (!text) return;

      if (onboarding) onboarding.remove();

      // ‚≠ê Rimuovi la suggestion selezionata
      const index = visibleSuggestions.indexOf(text);
      if (index !== -1) {
        visibleSuggestions.splice(index, 1);

        // ‚≠ê Se ci sono altre suggestions rimanenti ‚Üí aggiungine una
        if (remainingSuggestions.length > 0) {
          const next = remainingSuggestions.shift();
          visibleSuggestions.push(next);
        }
      }

      addMessage("user", text);

      const typingBubble = showTyping();
      messages.push({ role: "user", content: text });
      controller = new AbortController();

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({ messages, stream: true }),
          signal: controller.signal
        });

        if (!response.ok || !response.body) {
          throw new Error("Errore API Langbase");
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let full = "";

        typingBubble.remove();
        const aiBubble = addAiResponse("");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split("\n").filter(Boolean);

          for (const line of lines) {
            let data = line.replace("data:", "").trim();
            try {
              const json = JSON.parse(data);
              const delta =
                json?.choices?.[0]?.delta?.content ??
                json?.content ??
                json?.delta ?? "";

              if (delta) {
                full += delta;
                aiBubble.textContent = full;
              }
            } catch {
              full += data;
              aiBubble.textContent = full;
            }
          }
        }

        messages.push({ role: "assistant", content: full });

        // ‚≠ê Dopo la risposta ‚Üí mostra le suggestions rimanenti
        if (visibleSuggestions.length > 0) {
          renderSuggestions();
        }

      } catch (err) {
        typingBubble.remove();
        addAiResponse("Please contact my creator");
      }
    }

    // Eventi
    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (text) {
        handleQuestion(text);
        input.value = "";
      }
    };

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const text = input.value.trim();
        if (text) {
          handleQuestion(text);
          input.value = "";
        }
      }
    });

    document.querySelectorAll(".tip").forEach(tip => {
      tip.addEventListener("click", () => {
        handleQuestion(tip.textContent);
      });
    });

    themeToggle.onclick = () => {
      if (document.body.classList.contains("dark")) {
        document.body.classList.remove("dark");
        document.body.classList.add("light");
      } else {
        document.body.classList.remove("light");
        document.body.classList.add("dark");
      }
    };

  </script>
</body>

</html>
