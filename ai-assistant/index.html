<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>V.E.R.A.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://api.fontshare.com/v2/css?f[]=general-sans@400,500,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="ai_assistant_styles.css">
</head>

<!-- ‚≠ê DEFAULT: DARK MODE -->

<body class="dark-mode">

  <!-- Dark mode toggle -->
  <span class="w3-button w3-top w3-white w3-xlarge w3-text-grey w3-hover-text-black"
    style="width:auto; left:0; background-color: transparent !important" onclick="toggleDarkMode()">
    <i id="themeIcon" class="fa fa-moon-o"></i>
  </span>

  <div class="container">
    <header>
      <span>V.E.R.A. (Valerio‚Äôs Enhanced RAG Assistant)</span>

      <div class="header-right">
        <button class="classic-icon-btn" title="Open classic CV site" onclick="window.location.href='../index.html'">
          üè†Ô∏é
        </button>

        <button class="classic-icon-btn" title="Reload page" onclick="location.reload()">
          ‚ü≥
        </button>
      </div>
    </header>

    <div id="chat" class="chat">
      <div id="onboarding" class="onboarding">
        <div class="avatar-large" id="avatarLarge">
          <img src="../images/avatar.png" alt="Avatar">
        </div>

        <div class="greeting">
          Hi there üëã, I‚Äôm V.E.R.A.<br>
          I can help you explore Valerio‚Äôs experience, skills, and career.<br>
          Write your question below, or pick one of the suggestions.
        </div>

        <div class="tips">
          <div class="tip">Tell me about Valerio?</div>
          <div class="tip">What is Valerio‚Äôs work experience?</div>
          <div class="tip">Has Valerio published anything?</div>
          <div class="tip">What is Valerio‚Äôs education?</div>
          <div class="tip">How can I reach Valerio?</div>
        </div>
      </div>
    </div>

    <div class="composer">
      <textarea id="input" placeholder="Write a question..."></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const API_URL = "https://api.langbase.com/v1/pipes/run";
    const API_KEY = "";

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const onboarding = document.getElementById("onboarding");

    let controller = null;
    const messages = [];

    const allSuggestions = [
      "Tell me about Valerio?",
      "What is Valerio‚Äôs work experience?",
      "Has Valerio published anything?",
      "What is Valerio‚Äôs education?",
      "How can I reach Valerio?"
    ];

    let visibleSuggestions = allSuggestions.slice(0, 3);
    let remainingSuggestions = allSuggestions.slice(3);

    function renderSuggestions() {
      const tipsContainer = document.createElement("div");
      tipsContainer.className = "tips";

      visibleSuggestions.forEach(s => {
        const tip = document.createElement("div");
        tip.className = "tip";
        tip.textContent = s;
        tip.onclick = () => handleQuestion(s);
        tipsContainer.appendChild(tip);
      });

      chat.appendChild(tipsContainer);
      chat.scrollTop = chat.scrollHeight;
    }

    function addMessage(role, text) {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function showTyping() {
      const wrapper = document.createElement("div");
      wrapper.className = "typing-indicator";
      wrapper.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      return wrapper;
    }

    function addAiResponse(text) {
      const row = document.createElement("div");
      row.className = "thought";

      row.innerHTML = `
        <div class="msg ai">${text}</div>
        <div class="avatar-small">
          <img src="../images/avatar.png" alt="Avatar">
        </div>
      `;

      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return row.querySelector(".msg.ai");
    }

    async function handleQuestion(text) {
      if (!text) return;

      if (onboarding) onboarding.remove();

      const index = visibleSuggestions.indexOf(text);
      if (index !== -1) {
        visibleSuggestions.splice(index, 1);
        if (remainingSuggestions.length > 0) {
          visibleSuggestions.push(remainingSuggestions.shift());
        }
      }

      addMessage("user", text);

      const typingBubble = showTyping();
      messages.push({ role: "user", content: text });
      controller = new AbortController();

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({ messages, stream: true }),
          signal: controller.signal
        });

        if (!response.ok || !response.body) throw new Error("API error");

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let full = "";

        typingBubble.remove();
        const aiBubble = addAiResponse("");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split("\n").filter(Boolean);

          for (const line of lines) {
            let data = line.replace("data:", "").trim();
            try {
              const json = JSON.parse(data);
              const delta =
                json?.choices?.[0]?.delta?.content ??
                json?.content ??
                json?.delta ?? "";

              if (delta) {
                full += delta;
                aiBubble.textContent = full;
              }
            } catch {
              full += data;
              aiBubble.textContent = full;
            }
          }
        }

        messages.push({ role: "assistant", content: full });

        if (visibleSuggestions.length > 0) renderSuggestions();

      } catch (err) {
        typingBubble.remove();
        addAiResponse("Sorry‚Ä¶ Valerio has temporarily disabled me üòî If you‚Äôd like me back online, you can contact him at <strong>valerioserino.info@gmail.com</strong> or return to the homepage to visit his website.");
      }
    }

    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (text) {
        handleQuestion(text);
        input.value = "";
      }
    };

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const text = input.value.trim();
        if (text) {
          handleQuestion(text);
          input.value = "";
        }
      }
    });

    document.querySelectorAll(".tip").forEach(tip => {
      tip.addEventListener("click", () => handleQuestion(tip.textContent));
    });

    /* ‚≠ê DARK MODE TOGGLE ‚Äî allineato al CSS */
    function toggleDarkMode() {
      const body = document.body;
      const icon = document.getElementById("themeIcon");

      body.classList.toggle("dark-mode");

      if (body.classList.contains("dark-mode")) {
        icon.classList.remove("fa-sun-o");
        icon.classList.add("fa-moon-o");
      } else {
        icon.classList.remove("fa-moon-o");
        icon.classList.add("fa-sun-o");
      }
    }
  </script>

</body>

</html>